# nginx ì„¤ì • íŒŒì¼ (C:\nginx\conf\nginx.conf)
# Express API ì„œë²„ì™€ ì—°ë™í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ + API ì„œë¹™

# ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìˆ˜ (CPU ì½”ì–´ ìˆ˜ì™€ ë§ì¶”ëŠ” ê²ƒì´ ì¼ë°˜ì )
worker_processes  auto;

# ì´ë²¤íŠ¸ ë¸”ë¡ - ì—°ê²° ì²˜ë¦¬ ì„¤ì •
events {
    worker_connections  1024;  # ì›Œì»¤ë‹¹ ìµœëŒ€ ë™ì‹œ ì—°ê²° ìˆ˜
}

# HTTP ë¸”ë¡ - ì›¹ì„œë²„ ë©”ì¸ ì„¤ì •
http {
    # MIME íƒ€ì… ì„¤ì • í¬í•¨
    include       mime.types;
    default_type  application/octet-stream;
    server_tokens off;
    more_clear_headers Server;
    
    # íŒŒì¼ ì „ì†¡ ìµœì í™”
    sendfile        on;
    keepalive_timeout  65;
    
    # ì—…ë¡œë“œ íŒŒì¼ í¬ê¸° ì œí•œ (100MBê¹Œì§€ í—ˆìš©)
    client_max_body_size 100m;
    
    # ========================================
    # ì„±ëŠ¥ ìµœì í™” ì˜µì…˜ (http ë¸”ë¡ ë ˆë²¨)
    # ========================================
    
    # gzip ì••ì¶• í™œì„±í™” (ëŒ€ì—­í­ ì ˆì•½)
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;
    
    # ========================================
    # ìš”ì²­ ì œí•œ ì„¤ì •
    # ========================================
    limit_req_zone $binary_remote_addr zone=general:10m rate=100r/m;
    limit_req_zone $binary_remote_addr zone=api:10m rate=300r/m;
    limit_req_zone $binary_remote_addr zone=login:10m rate=10r/m;
    
    # ë©”ì¸ ì„œë²„ ë¸”ë¡
    server {
        # 80í¬íŠ¸ì—ì„œ ìˆ˜ì‹ 
        listen       80;
        server_name  localhost;
        
        # ========================================
        # ğŸ”’ IP ì œí•œ ì„¤ì • (ë§¨ ìœ„ì— ë°°ì¹˜)
        # ========================================
        
        # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ í—ˆìš©
        allow 192.168.0.0/16;    # 192.168.x.x ëŒ€ì—­
        #allow 10.0.0.0/8;        # 10.x.x.x ëŒ€ì—­  
        allow 172.16.0.0/12;     # 172.16-31.x.x ëŒ€ì—­
        allow 127.0.0.1;         # ë¡œì»¬í˜¸ìŠ¤íŠ¸
        deny all;                # ì™¸ë¶€ IP ëª¨ë‘ ì°¨ë‹¨
        
        # ë˜ëŠ” íŠ¹ì • IPë§Œ í—ˆìš©í•˜ë ¤ë©´ ìœ„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  ì•„ë˜ ì‚¬ìš©:
        # allow 192.168.10.50;   # ì‚¬ë¬´ì‹¤ PC
        # allow 192.168.1.101;   # ê´€ë¦¬ì PC
        # allow 127.0.0.1;       # ë¡œì»¬í˜¸ìŠ¤íŠ¸
        # deny all;              # ë‚˜ë¨¸ì§€ ì°¨ë‹¨
        
        # ========================================
        # ğŸ”§ ì¤‘ìš”: ì—…ë¡œë“œ íŒŒì¼ ë¨¼ì € ì²˜ë¦¬ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
        # ========================================
        location /uploads/ {
            alias C:/jamtori/server/uploads/;
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }
        
        # ========================================
        # API í”„ë¡ì‹œ (Express ì„œë²„ë¡œ ì „ë‹¬)
        # ========================================
        location /api/ {
            # ì¼ë°˜ API ìš”ì²­ ì œí•œ
            limit_req zone=api burst=30 nodelay;
            
            # Express API ì„œë²„(4000í¬íŠ¸)ë¡œ í”„ë¡ì‹œ
            proxy_pass http://127.0.0.1:4000/api/;
            
            # í”„ë¡ì‹œ í—¤ë” ì„¤ì • (í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ì „ë‹¬)
            proxy_set_header Host $host;                    # í˜¸ìŠ¤íŠ¸ëª… ì „ë‹¬
            proxy_set_header X-Real-IP $remote_addr;        # ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IP
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # í”„ë¡ì‹œ ì²´ì¸ IP
            proxy_set_header X-Forwarded-Proto $scheme;     # HTTP/HTTPS í”„ë¡œí† ì½œ
        }
        
        # ========================================
        # ë¡œê·¸ì¸ API íŠ¹ë³„ ì œí•œ
        # ========================================
        location /api/auth/login {
            # ë¡œê·¸ì¸ ì‹œë„ ì œí•œ (ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ë°©ì§€)
            limit_req zone=login burst=3 nodelay;
            
            proxy_pass http://127.0.0.1:4000/api/auth/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # ========================================
        # ê´€ë¦¬ì API ë” ì—„ê²©í•œ ì œí•œ
        # ========================================
        location /api/admin/ {
            # ê´€ë¦¬ì APIëŠ” ë” íŠ¹ì • IPë§Œ í—ˆìš© (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
            # allow 192.168.1.100;   # ê´€ë¦¬ì PCë§Œ
            # allow 127.0.0.1;       # ë¡œì»¬í˜¸ìŠ¤íŠ¸
            # deny all;              # ë‚˜ë¨¸ì§€ ì°¨ë‹¨
            
            limit_req zone=api burst=15 nodelay;
            
            proxy_pass http://127.0.0.1:4000/api/admin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # ========================================
        # ğŸ”§ ìˆ˜ì •: í´ë¼ì´ì–¸íŠ¸ ì •ì  íŒŒì¼ë§Œ ìºì‹± (uploads ì œì™¸)
        # ========================================
        location ~* ^(?!/uploads/).*\.(css|js|woff|woff2|ttf|eot)$ {
            root   C:/jamtori/client/dist;
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header Vary Accept-Encoding;
        }
        
        # ========================================
        # í´ë¼ì´ì–¸íŠ¸ ì •ì  íŒŒì¼ ì„œë¹™ (React ì•±)
        # ========================================
        location / {
            # ì¼ë°˜ í˜ì´ì§€ ìš”ì²­ ì œí•œ
            limit_req zone=general burst=20 nodelay;
            
            root   C:/jamtori/client/dist;
            index  index.html index.htm;
            
            # SPA(Single Page Application) ë¼ìš°íŒ… ì§€ì›
            # ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ë¡œëŠ” ëª¨ë‘ index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            try_files $uri $uri/ /index.html;
        }
        
        # ========================================
        # ì—ëŸ¬ í˜ì´ì§€ ì„¤ì •
        # ========================================
        # 500 ì—ëŸ¬ ì‹œ í‘œì‹œí•  í˜ì´ì§€
        error_page   500 501 502 503 504  /50x.html;
        location = /errors/50x.html {
            root C:/jamtori/errors;  # C:\nginx\html\50x.html íŒŒì¼ ì‚¬ìš©
            internal;
        }
        
        # 400 ì—ëŸ¬ ì‹œ ì»¤ìŠ¤í…€ í˜ì´ì§€
        error_page 400 401 402 403 404 /errors/40x.html;
        location = /errors/40x.html {
            root C:/jamtori/errors;
            internal;
        }
        
    } # âœ… server ë¸”ë¡ ì¢…ë£Œ
} # âœ… http ë¸”ë¡ ì¢…ë£Œ

# ========================================
# ğŸ”§ ìˆ˜ì • ì‚¬í•­ ì„¤ëª…
# ========================================
#
# ê¸°ì¡´ ë¬¸ì œ í•´ê²°:
# - ì •ì  íŒŒì¼ ìºì‹± ì„¤ì •ì´ /uploads/ ê²½ë¡œì˜ ì´ë¯¸ì§€ë„ client/distì—ì„œ ì°¾ìŒ
# - nginx location ìš°ì„ ìˆœìœ„ ë•Œë¬¸ì— í™•ì¥ì ê¸°ë°˜ ì„¤ì •ì´ ë¨¼ì € ì ìš©ë¨
#
# ìƒˆë¡œìš´ ë³´ì•ˆ ê¸°ëŠ¥ ì¶”ê°€:
# 1. IP ì œí•œ: ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ í—ˆìš©
# 2. ìš”ì²­ ì œí•œ: ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ë°©ì§€
# 3. ë¡œê·¸ì¸ API íŠ¹ë³„ ì œí•œ
# 4. ê´€ë¦¬ì API ì¶”ê°€ ë³´ì•ˆ
#
# ë™ì‘ íë¦„:
# - IP ì²´í¬ â†’ í—ˆìš©ëœ IPë§Œ í†µê³¼
# - /uploads/images/test.jpg â†’ uploads location (ì„œë²„ íŒŒì¼)
# - /assets/index.js â†’ ì •ì  íŒŒì¼ ìºì‹± (í´ë¼ì´ì–¸íŠ¸ íŒŒì¼)
# - /api/* â†’ Express í”„ë¡ì‹œ (ìš”ì²­ ì œí•œ ì ìš©)
# - / â†’ React ì•± (ìš”ì²­ ì œí•œ ì ìš©)
#
# ë³´ì•ˆ ë ˆë²¨:
# - ì¼ë°˜ í˜ì´ì§€: 30íšŒ/ë¶„
# - API: 60íšŒ/ë¶„
# - ë¡œê·¸ì¸: 5íšŒ/ë¶„
# - ê´€ë¦¬ì API: ì¶”ê°€ IP ì œí•œ ê°€ëŠ¥
#
# ========================================
